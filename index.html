<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HyperRocks - On-Chain Floating Galaxy</title>
  <meta name="description" content="1111 Unique HyperRocks SVGs Generated Live from Contract â€¢ Floating in HyperSpace" />
  <link rel="stylesheet" href="main.css">
</head>
<body>

  <div class="particle-bg" id="stars"></div>

  <div class="logo">ðŸª¨</div>
  <h1>HyperRocks</h1>
  <p class="tagline">1111 On-Chain SVGs via buildSVG â€¢ Floating in HyperSpace</p>
  <a href="https://hyperevmscan.io/address/0x4CF79252EA6861c4338284e1A1F724d4e7ef667b#readContract" target="_blank" class="contract-link">
    Read Contract on HyperEVMScan
  </a>
  <input type="text" class="search-bar" id="search" placeholder="Search & Summon Token ID (e.g., 420)" />

  <div class="container" id="container"></div>
  <div class="loading-more" id="loading-more">Summoning more rocks from the chain...</div>
  <div class="progress" id="progress">Loaded 0/1111</div>
  
  

  <footer>HyperRocks â€¢ Live buildSVG Calls â€¢ HyperEVM Chain ID 999</footer>

  <script>
    // Minimal: Floating stars + simple HyperRock SVG viewer with selector & fallback

    // Twinkling stars
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 4 + 's';
      starsContainer.appendChild(star);
    }

    // Viewer config
    const CONTRACT = '0x4CF79252EA6861c4338284e1A1F724d4e7ef667b';
    const RPC = 'https://rpc.hyperliquid.xyz/evm';
    const SELECTOR = '0x3e53eb28';
    const TOTAL = 1111;

    // Hex and RPC helpers
    function padHex(num, bytes = 32) {
      // fixes case where hex string could be longer than 32 bytes if not parsed as integer
      let hex = Number(num).toString(16);
      if (hex.length > bytes * 2) hex = hex.slice(-bytes * 2);
      return '0x' + '0'.repeat(bytes * 2 - hex.length) + hex;
    }
    function hexToUtf8(hex) {
      // Remove 0x prefix if present
      if (!hex.startsWith('0x')) hex = '0x' + hex;
      // Ensure hex string has even length (pad with 0 if odd)
      if ((hex.length - 2) % 2 !== 0) {
        hex = hex.slice(0, 2) + '0' + hex.slice(2);
      }
      const bytes = [];
      for (let i = 2; i < hex.length; i += 2) {
        const byte = parseInt(hex.substr(i, 2), 16);
        if (isNaN(byte)) {
          console.warn(`Invalid hex byte at position ${i}: ${hex.substr(i, 2)}`);
          continue;
        }
        bytes.push(byte);
      }
      // Find first 0 byte, indicating possible end of utf-8 string
      let end = bytes.indexOf(0);
      if (end === -1) end = bytes.length;
      // Correct: check for empty string
      if (end === 0) return "";
      const decoder = new TextDecoder('utf-8');
      const decoded = decoder.decode(new Uint8Array(bytes.slice(0, end))).trim();
      console.log(`Decoded string length: ${decoded.length}, starts with: ${decoded.substring(0, 20)}...`);
      return decoded;
    }

    async function fetchSVG(tokenId) {
      // Carefully pad hex value so selector + input is correct
      const data = SELECTOR + padHex(tokenId).slice(2);
      try {
        const res = await fetch(RPC, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            id: tokenId,
            method: 'eth_call',
            params: [{ to: CONTRACT, data }, 'latest']
          })
        });

        // Check for HTTP error
        if (!res.ok) {
          throw new Error(`HTTP error ${res.status}`);
        }

        const json = await res.json();
        // Defensive: log raw returned JSON
        console.log("eth_call result", json);

        // Check for JSON-RPC error response
        if (json.error) {
          throw new Error(`RPC error: ${json.error.message || JSON.stringify(json.error)}`);
        }

        if (!json || typeof json.result !== "string" || json.result === '0x') {
          throw new Error('No result from eth_call');
        }
        // The result is a hex string, its decoded result should be the SVG string
        const svg = hexToUtf8(json.result);

        // If SVG is clearly invalid, throw error
        if (typeof svg !== "string" || !svg.trim().startsWith('<svg')) {
          // if (typeof svg !== "string" ) {
          console.log(`Invalid SVG: ${svg}`);
          
          throw new Error('Invalid SVG');
        }
        return `data:image/svg+xml;charset=utf-8,${svg}`;
      } catch (err) {
        // Log to help diagnose
        console.error("Error in fetchSVG:", err);
        throw err;
      }
    }

    // Create (or use) viewer container and UI
    let viewer = document.getElementById('dynamic-rock-viewer');
    if (!viewer) {
      viewer = document.createElement('div');
      viewer.id = 'dynamic-rock-viewer';
      viewer.style.maxWidth = "540px";
      viewer.style.margin = "30px auto";
      viewer.style.background = "rgba(10,20,40,0.85)";
      viewer.style.borderRadius = "24px";
      viewer.style.boxShadow = "0 0 40px #00d4ff33";
      viewer.style.padding = "24px";
      viewer.style.display = "flex";
      viewer.style.flexDirection = "column";
      viewer.style.alignItems = "center";
      let before = document.getElementById('container');
      before.parentNode.insertBefore(viewer, before);
    }
    viewer.innerHTML = `
      <div style="display:flex;align-items:center;gap:18px">
        <button id="viewer-left">&#9664;</button>
        <img id="viewer-img" style="width:290px;min-height:110px;background:#101f32;border-radius:16px;box-shadow: 0 0 30px #00d4ff80;" />
        <button id="viewer-right">&#9654;</button>
      </div>
      <div style="margin-top:8px;">HyperRock #<span id="viewer-id"></span> / ${TOTAL}</div>
      <input id="viewer-input" type="number" min="1" max="${TOTAL}" placeholder="Go to Token ID" style="margin-top:8px;width:130px;text-align:center;" />
      <div id="viewer-error" style="margin-top:8px;color:orange;display:none;"></div>
    `;
    const viewerImg = document.getElementById('viewer-img');
    const viewerLeft = document.getElementById('viewer-left');
    const viewerRight = document.getElementById('viewer-right');
    const viewerIdSpan = document.getElementById('viewer-id');
    const viewerInput = document.getElementById('viewer-input');
    const viewerError = document.getElementById('viewer-error');
    // fallback SVG
    const fallbackSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="512" height="512"><rect width="32" height="32" fill="#00d4ff"/><rect x="8" y="8" width="16" height="16" rx="8" fill="#0f0f1a" opacity="0.8"/><circle cx="16" cy="16" r="6" fill="#00d4ff" opacity="0.6"/></svg>`;
    const fallbackURL = `data:image/svg+xml;base64,${btoa(fallbackSvg)}`;

    // Main updating logic
    let curId = 1;
    async function updateViewer(id) {
      if (isNaN(id) || id < 1 || id > TOTAL) return;
      curId = id;
      viewerIdSpan.textContent = id;
      viewerImg.src = '';
      viewerError.style.display = 'none';
      try {
        const imgSrc = await fetchSVG(id);
        console.log(`ImgSrc: ${imgSrc}`);
        viewerImg.src = imgSrc;
        viewerImg.alt = `HyperRock #${id}`;
        viewerError.style.display = 'none';
        viewerError.textContent = '';
      } catch (e) {
        viewerImg.src = fallbackURL;
        viewerImg.alt = `Not Found`;
        viewerError.style.display = '';
        viewerError.textContent = 'Error loading SVG for #' + id + ': ' + (e.message || e);
      }
    }

    // Navigation
    viewerLeft.onclick = () => updateViewer(curId > 1 ? curId - 1 : TOTAL);
    viewerRight.onclick = () => updateViewer(curId < TOTAL ? curId + 1 : 1);
    viewerInput.onchange = ev => {
      const n = Number(viewerInput.value);
      if(n>=1&&n<=TOTAL) updateViewer(n);
    };
    viewerInput.onkeydown = ev => {
      if(ev.key==="Enter") viewerInput.onchange();
    };
    window.addEventListener('keydown', e => {
      if(document.activeElement===viewerInput) return;
      if(e.key==="ArrowLeft") { updateViewer(curId > 1 ? curId - 1 : TOTAL); e.preventDefault(); }
      if(e.key==="ArrowRight") { updateViewer(curId < TOTAL ? curId + 1 : 1); e.preventDefault(); }
    });

    // Initial load
    updateViewer(curId);
  </script>
</body>
</html>
