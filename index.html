<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HyperRocks - On-Chain Floating Galaxy</title>
  <meta name="description" content="1111 Unique HyperRocks SVGs Generated Live from Contract â€¢ Floating in HyperSpace" />
  <link rel="stylesheet" href="main.css">
</head>
<body>

  <div class="particle-bg" id="stars"></div>

  <div class="logo">ðŸª¨</div>
  <h1>HyperRocks</h1>
  <p class="tagline">1111 On-Chain SVGs via buildSVG â€¢ Floating in HyperSpace</p>
  <a href="https://hyperevmscan.io/address/0x4CF79252EA6861c4338284e1A1F724d4e7ef667b#readContract" target="_blank" class="contract-link">
    Read Contract on HyperEVMScan
  </a>
  <input type="text" class="search-bar" id="search" placeholder="Search & Summon Token ID (e.g., 420)" />

  <div class="container" id="container"></div>
  <div class="loading-more" id="loading-more">Summoning more rocks from the chain...</div>
  <div class="progress" id="progress">Loaded 0/1111</div>
  
  

  <footer>HyperRocks â€¢ Live buildSVG Calls â€¢ HyperEVM Chain ID 999</footer>

  <script>
    // Twinkling stars
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 4 + 's';
      starsContainer.appendChild(star);
    }

    // Config
    const CONTRACT = '0x4CF79252EA6861c4338284e1A1F724d4e7ef667b';
    const RPC = 'https://rpc.hyperliquid.xyz/evm';
    const SELECTOR = '0x54f82ed7'; // keccak256('buildSVG(uint256)')
    const TOTAL = 1111;

    // Container for dynamic loader
    const dynamicContainerId = 'dynamic-rock-viewer';
    let dynamicViewer = document.getElementById(dynamicContainerId);
    if (!dynamicViewer) {
      dynamicViewer = document.createElement('div');
      dynamicViewer.id = dynamicContainerId;
      dynamicViewer.style.position = "relative";
      dynamicViewer.style.margin = "30px auto";
      dynamicViewer.style.width = "520px";
      dynamicViewer.style.maxWidth = "95vw";
      dynamicViewer.style.display = "flex";
      dynamicViewer.style.flexDirection = "column";
      dynamicViewer.style.alignItems = "center";
      dynamicViewer.style.background = "rgba(10,20,40,0.85)";
      dynamicViewer.style.borderRadius = "24px";
      dynamicViewer.style.boxShadow = "0 0 40px #00d4ff33";
      dynamicViewer.style.padding = "36px 0 18px 0";
      dynamicViewer.style.zIndex = 10;
      // Insert before the floating rocks galaxy
      const container = document.getElementById('container');
      container.parentNode.insertBefore(dynamicViewer, container);
    }

    // Inject buttons & image root
    dynamicViewer.innerHTML = `
      <div style="display:flex; justify-content:center; gap:40px;">
        <button id="viewer-left" style="font-size:2rem; padding: 8px 18px; border-radius:10px; border:none; background:#101f4a; color:#00d4ff; cursor:pointer;">&#9664; Left</button>
        <div id="viewer-img-div" style="display:flex; flex-direction:column; align-items:center;">
          <div id="viewer-loading" style="font-size:1.1rem; color:#00d4ff; margin-bottom:12px; display:none;">Summoning rock...</div>
          <img id="viewer-img" src="" alt="HyperRock" style="box-shadow: 0 0 50px #00d4ff80; border-radius:16px; width:420px; max-width:90vw; min-height:210px; background:#101f32;" />
          <div id="viewer-fallback" style="color:#fff; opacity:0.8; margin-top:10px; display:none;">Fallback galaxy SVG</div>
        </div>
        <button id="viewer-right" style="font-size:2rem; padding: 8px 18px; border-radius:10px; border:none; background:#101f4a; color:#00d4ff; cursor:pointer;">Right &#9654;</button>
      </div>
      <div id="viewer-desc" style="font-size:1.1rem; color:#00d4ff; margin-top: 14px;">HyperRock #<span id="viewer-id">1</span> / 1111</div>
      <input type="number" id="viewer-input" min="1" max="${TOTAL}" placeholder="Go to Token ID" style="font-size:1.1rem; border-radius:8px; border:1px solid #00d4ff99; margin-top:14px; width:170px; text-align:center; padding:5px;" />
    `;

    // Setup references
    const viewerImg = document.getElementById('viewer-img');
    const viewerLeft = document.getElementById('viewer-left');
    const viewerRight = document.getElementById('viewer-right');
    const viewerDesc = document.getElementById('viewer-desc');
    const viewerLoading = document.getElementById('viewer-loading');
    const viewerFallback = document.getElementById('viewer-fallback');
    const viewerIdSpan = document.getElementById('viewer-id');
    const viewerInput = document.getElementById('viewer-input');

    // Hex utils
    function padHex(num, bytes = 32) {
      const hex = num.toString(16);
      return '0x' + '0'.repeat(bytes * 2 - hex.length) + hex;
    }
    function hexToUtf8(hex) {
      if (!hex.startsWith('0x')) hex = '0x' + hex;
      let str = '';
      for (let i = 2; i < hex.length; i += 2) {
        const code = parseInt(hex.substr(i, 2), 16);
        // Handle null bytes and ensure valid character codes
        if (code === 0 && str.length > 0) {
          // Stop at first null byte (common in Solidity string returns)
          break;
        }
        if (code > 0) {
          str += String.fromCharCode(code);
        }
      }
      // Trim any trailing whitespace/null characters
      return str.trim();
    }

    // Fetch SVG from contract's buildSVG
    async function fetchSVG(tokenId) {
      const data = SELECTOR + padHex(tokenId).slice(2); // Full calldata
      const response = await fetch(RPC, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 1,
          method: 'eth_call',
          params: [{ to: CONTRACT, data }, 'latest']
        })
      });
      if (!response.ok) throw new Error(`RPC ${response.status}`);
      const { result } = await response.json();
      if (!result || result === '0x') throw new Error('Empty result - token may not exist');
      const svg = hexToUtf8(result);
      if (!svg.startsWith('<svg')) throw new Error('Invalid SVG');
      // Use URL encoding instead of base64 for better compatibility with special characters
      return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
    }

    // State
    let currentId = 1;
    let loadingId = null; // Track which tokenId we're currently loading
    async function updateViewer(id) {
      if (isNaN(id) || id < 1 || id > TOTAL) return;
      currentId = id;
      loadingId = id; // Set the loading tokenId
      viewerIdSpan.textContent = id;
      viewerDesc.style.color = '#00d4ff';
      viewerImg.style.filter = "";
      viewerImg.style.opacity = '0.1';
      viewerLoading.style.display = 'block';
      viewerFallback.style.display = 'none';
      viewerImg.alt = `HyperRock #${id}`;
      
      // Clear previous event handlers to prevent them from firing
      viewerImg.onerror = null;
      viewerImg.onload = null;
      
      // Clear src to cancel any pending loads
      viewerImg.src = '';
      
      try {
        const svgSrc = await fetchSVG(id);
        
        // Check if we're still loading the same tokenId (user might have navigated away)
        if (loadingId !== id) return;
        
        // Set error handler BEFORE setting src to avoid race conditions
        viewerImg.onerror = () => {
          // Only handle error if this is still the current tokenId
          if (loadingId === id) {
            viewerFallback.style.display = 'block';
            viewerImg.src = fallbackSVGDataUrl;
          }
        };
        
        // Set load handler BEFORE setting src
        viewerImg.onload = function() {
          // Only handle load if this is still the current tokenId
          if (loadingId === id) {
            viewerImg.style.opacity = '1';
            viewerLoading.style.display = 'none';
          }
        };
        
        // Now set the src
        viewerImg.src = svgSrc;
      } catch (e) {
        // Only set fallback if we're still loading the same tokenId
        if (loadingId === id) {
          viewerFallback.style.display = 'block';
          viewerImg.src = fallbackSVGDataUrl;
          viewerDesc.style.color = 'orange';
          viewerImg.alt = `HyperRock #${id} (Fallback)`;
          viewerImg.style.opacity = '1';
          viewerLoading.style.display = 'none';
        }
      }
      
      // Fallback timeout - only apply if still loading same tokenId
      setTimeout(() => {
        if (loadingId === id) {
          viewerImg.style.opacity = '1';
          viewerLoading.style.display = 'none';
        }
      }, 700); // just in case image onload fails
    }

    // Fallback SVG data url
    const fallbackSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="512" height="512" shape-rendering="crispEdges"><rect width="32" height="32" fill="#00d4ff"/><rect x="8" y="8" width="16" height="16" rx="8" fill="#0f0f1a" opacity="0.8"/><circle cx="16" cy="16" r="6" fill="#00d4ff" opacity="0.6"/></svg>`;
    const fallbackSVGDataUrl = `data:image/svg+xml;base64,${btoa(fallbackSvg)}`;

    // Button logic
    function goLeft() {
      const next = currentId > 1 ? currentId - 1 : TOTAL;
      updateViewer(next);
    }
    function goRight() {
      const next = currentId < TOTAL ? currentId + 1 : 1;
      updateViewer(next);
    }
    viewerLeft.addEventListener('click', goLeft);
    viewerRight.addEventListener('click', goRight);

    // Allow arrow keys navigation
    window.addEventListener('keydown', (e) => {
      if (document.activeElement === viewerInput) return;
      if (e.key === 'ArrowLeft') {
        goLeft();
        e.preventDefault();
      }
      if (e.key === 'ArrowRight') {
        goRight();
        e.preventDefault();
      }
    });

    // Input for jump directly
    viewerInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const n = Number(viewerInput.value.trim());
        if (n >= 1 && n <= TOTAL) {
          updateViewer(n);
        }
      }
    });
    viewerInput.addEventListener('change', () => {
      const n = Number(viewerInput.value.trim());
      if (n >= 1 && n <= TOTAL) {
        updateViewer(n);
      }
    });

    // Initial load
    updateViewer(currentId);
  </script>
</body>
</html>
