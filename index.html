<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HyperRocks Gallery â€“ Animated Eyeframe</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --card: #1a1a2e;
      --accent: #00d4ff;
      --text: #e0e0ff;
      --glow: 0 0 25px rgba(0, 212, 255, 0.6);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-x: hidden;
    }
    .logo {
      width: 100px;
      height: 100px;
      margin: 20px auto;
      filter: drop-shadow(0 0 20px var(--accent));
      animation: float 6s infinite ease-in-out;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    h1 {
      font-size: 3em;
      color: var(--accent);
      text-shadow: var(--glow);
      margin: 10px 0 5px;
    }
    .tagline {
      font-size: 1.2em;
      color: #88aaff;
      margin-bottom: 30px;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
      font-size: 1.1em;
    }
    .stat {
      background: var(--card);
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid var(--accent);
    }
    .eyeframe {
      width: 100%;
      max-width: 1000px;
      height: 600px;
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      box-shadow: var(--glow);
      margin: 30px auto;
    }
    .eyeframe-canvas {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, #1a1a2e, #0f0f1a);
    }
    .rock-svg {
      width: 80%;
      height: 80%;
      filter: drop-shadow(0 0 30px var(--accent));
      animation: pulse 4s infinite ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.05) rotate(2deg); }
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    .btn {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn:hover {
      background: var(--accent);
      color: #000;
      box-shadow: var(--glow);
    }
    .btn.active {
      background: var(--accent);
      color: #000;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 1300px;
      padding: 0 20px;
      margin-top: 30px;
    }
    .thumb {
      background: var(--card);
      border: 1px solid var(--accent);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      opacity: 0.7;
    }
    .thumb:hover, .thumb.active {
      opacity: 1;
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0,212,255,0.8);
    }
    .thumb svg {
      width: 100%;
      height: 150px;
      object-fit: contain;
    }
    .loading {
      color: var(--accent);
      font-size: 1.3em;
      margin: 40px 0;
      animation: blink 1.5s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    footer {
      margin-top: 50px;
      font-size: 0.85em;
      color: #667;
    }
    .particle-bg {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    .star {
      position: absolute;
      width: 2px; height: 2px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0;
      animation: twinkle 5s infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0; }
      50% { opacity: 0.8; }
    }
    .contract-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9em;
      margin-top: 20px;
      display: inline-block;
    }
    .contract-link:hover {
      text-shadow: var(--glow);
    }
    .error {
      color: #ff6b6b;
      font-size: 1em;
      margin: 20px;
    }
  </style>
</head>
<body>

  <div class="particle-bg" id="stars"></div>

  <!-- Floating Rock Logo -->
  <div class="logo">ðŸª¨</div>

  <h1>HyperRocks Gallery</h1>
  <p class="tagline">Live animated SVGs from HyperEVM â€“ Click to explore</p>

  <div class="stats" id="stats"></div>

  <div class="loading" id="loading">Fetching animated rocks from HyperEVM...</div>
  <div class="error" id="error" style="display:none;"></div>

  <!-- EYEFROME DISPLAY -->
  <div class="eyeframe">
    <div class="eyeframe-canvas" id="eyeframe">
      <div style="color:var(--accent);font-size:2em;">Loading Rock...</div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="prevBtn">Previous</button>
    <button class="btn active" id="playBtn">Pause</button>
    <button class="btn" id="nextBtn">Next</button>
  </div>

  <!-- THUMBNAIL GALLERY -->
  <div class="gallery" id="gallery"></div>

  <a href="https://hyperevmscan.io/address/0x4CF79252EA6861c4338284e1A1F724d4e7ef667b" target="_blank" class="contract-link">View Contract on HyperEVMScan</a>

  <footer>HyperRocks â€¢ 1111 Unique â€¢ On-Chain SVG Generated</footer>

  <script>
    // === CONFIG ===
    const CONTRACT_ADDRESS = "0x4CF79252EA6861c4338284e1A1F724d4e7ef667b";
    const RPC_URL = "https://rpc.hyperliquid.xyz/evm"; // Mainnet HyperEVM RPC
    const TOTAL_TO_LOAD = 20; // Load first 20 minted rocks (adjust as needed)

    // Trait mappings (expanded from contract data)
    const TRAIT_MAPS = {
      background: ["#FFFFFF", "#D4D4D4", "#ABCDEF", "#FF0000", "#00FF00", "#0000FF"], // Example colors; replace with actual from contract
      flower: ["none", "orange", "pinkbushbig", "purple", "blue", "pink", "red", "white", "yellow", "pinkbushmed", "orangebush", "orangesmall", "pinkbushsmall", "purplesmall", "bluesmall"],
      mineral: ["none", "coal", "lapis", "quartz", "amethyst", "gold", "ruby", "emerald", "diamond"],
      sparkle: ["none", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "16"]
    };

    // ABI with confirmed functions
    const ABI = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function totalSupply() view returns (uint256)",
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function getTraits(uint256 tokenId) view returns (uint256 background, uint256 rock, uint256 flower, uint256 mineral, uint256 sparkle)",
      "function maxSupply() view returns (uint256)"
    ];

    // === DOM ===
    const loading = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const gallery = document.getElementById('gallery');
    const statsEl = document.getElementById('stats');
    const eyeframe = document.getElementById('eyeframe');
    const prevBtn = document.getElementById('prevBtn');
    const playBtn = document.getElementById('playBtn');
    const nextBtn = document.getElementById('nextBtn');
    const stars = document.getElementById('stars');

    // === STATE ===
    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
    let rocks = [];
    let currentIndex = 0;
    let isPlaying = true;
    let intervalId = null;

    // === HELPERS ===
    function showError(msg) {
      loading.style.display = 'none';
      errorEl.textContent = `Error: ${msg}`;
      errorEl.style.display = 'block';
    }

    function formatTraits(traits) {
      const [bg, rock, flower, mineral, sparkle] = traits;
      return {
        background: TRAIT_MAPS.background[bg] || `BG-${bg}`,
        rock: `Rock-${rock}`,
        flower: TRAIT_MAPS.flower[flower] || `Flower-${flower}`,
        mineral: TRAIT_MAPS.mineral[mineral] || `Mineral-${mineral}`,
        sparkle: TRAIT_MAPS.sparkle[sparkle] || `Sparkle-${sparkle}`
      };
    }

    function createAnimatedSVG(svgData) {
      // Parse and enhance SVG for animation
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgData, 'image/svg+xml');
      const svg = doc.documentElement;

      // Add dash animation to paths and rects
      svg.querySelectorAll('path, rect, ellipse, circle').forEach(el => {
        el.style.stroke = '#00d4ff';
        el.style.strokeWidth = '1';
        el.style.strokeDasharray = '100';
        el.style.strokeDashoffset = '100';
        el.style.animation = 'dash 3s linear infinite';
      });

      // Add central sparkle animation
      const sparkle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      sparkle.setAttribute('cx', '50%');
      sparkle.setAttribute('cy', '50%');
      sparkle.setAttribute('r', '5');
      sparkle.setAttribute('fill', 'rgba(0,212,255,0.8)');
      sparkle.style.animation = 'sparkle 2s infinite';
      svg.appendChild(sparkle);

      return svg.outerHTML;
    }

    // === EYEFROME DISPLAY ===
    function showInEyeframe(index) {
      const rock = rocks[index];
      if (!rock) return;

      // Update active thumb
      document.querySelectorAll('.thumb').forEach((t, i) => t.classList.toggle('active', i === index));

      let svgContent = rock.svg;
      if (svgContent && svgContent.includes('<svg')) {
        svgContent = createAnimatedSVG(svgContent);
      } else {
        svgContent = `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect width="32" height="32" fill="#1a1a2e"/><text x="16" y="18" text-anchor="middle" fill="#00d4ff" font-size="14">Rock #${rock.id}</text></svg>`;
      }

      eyeframe.innerHTML = `
        <div class="rock-svg">
          <img src="data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgContent)))}" alt="Rock ${rock.id}">
        </div>
        <div style="position:absolute;bottom:20px;left:20px;color:var(--accent);font-size:1.2em;">
          Rock #${rock.id} â€“ ${rock.traits.background} / ${rock.traits.mineral}
        </div>
      `;
    }

    // === AUTO PLAY ===
    function startAutoPlay() {
      stopAutoPlay();
      intervalId = setInterval(() => {
        currentIndex = (currentIndex + 1) % rocks.length;
        showInEyeframe(currentIndex);
      }, 4000);
    }

    function stopAutoPlay() {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
    }

    // === CONTROLS ===
    prevBtn.addEventListener('click', () => {
      currentIndex = (currentIndex - 1 + rocks.length) % rocks.length;
      showInEyeframe(currentIndex);
      if (isPlaying) startAutoPlay();
    });

    nextBtn.addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % rocks.length;
      showInEyeframe(currentIndex);
      if (isPlaying) startAutoPlay();
    });

    playBtn.addEventListener('click', () => {
      isPlaying = !isPlaying;
      playBtn.textContent = isPlaying ? 'Pause' : 'Play';
      playBtn.classList.toggle('active', isPlaying);
      if (isPlaying && rocks.length > 0) {
        startAutoPlay();
      } else {
        stopAutoPlay();
      }
    });

    // === THUMBNAIL SETUP ===
    function setupThumbnails() {
      document.querySelectorAll('.thumb').forEach((thumb, i) => {
        thumb.addEventListener('click', () => {
          currentIndex = i;
          showInEyeframe(i);
          if (isPlaying) startAutoPlay();
        });
      });
    }

    // === FETCH FUNCTIONS ===
    async function fetchStats() {
      try {
        const [name, symbol, totalSupply, maxSupply] = await Promise.all([
          contract.name(),
          contract.symbol(),
          contract.totalSupply(),
          contract.maxSupply()
        ]);
        statsEl.innerHTML = `
          <div class="stat">Name: ${name}</div>
          <div class="stat">Symbol: ${symbol}</div>
          <div class="stat">Minted: ${ethers.utils.formatUnits(totalSupply, 0)} / ${ethers.utils.formatUnits(maxSupply, 0)}</div>
        `;
      } catch (err) {
        console.error('Stats error:', err);
        statsEl.innerHTML = '<div class="stat">Stats: Loading...</div>';
      }
    }

    async function fetchRocks() {
      loading.textContent = 'Querying minted tokens...';
      try {
        const totalMinted = await contract.totalSupply();
        const numToLoad = Math.min(TOTAL_TO_LOAD, Number(totalMinted));
        const promises = [];
        for (let i = 0; i < numToLoad; i++) {
          promises.push(fetchRock(i));
        }
        const results = await Promise.all(promises);
        rocks = results.filter(r => r && r.svg);
        if (rocks.length === 0) {
          throw new Error('No minted rocks found. Check if tokens are minted.');
        }
        loading.style.display = 'none';
        displayThumbnails();
        showInEyeframe(0);
        startAutoPlay();
      } catch (err) {
        showError(`Failed to fetch rocks: ${err.message}. Ensure tokens are minted on-chain.`);
      }
    }

    async function fetchRock(tokenId) {
      try {
        const uri = await contract.tokenURI(tokenId);
        if (!uri) return null;

        // Parse JSON metadata from tokenURI
        const response = await fetch(uri);
        if (!response.ok) return null;
        const metadata = await response.json();

        // Extract SVG from image field (base64 data URL)
        const imageDataUrl = metadata.image;
        let svg = '';
        if (imageDataUrl && imageDataUrl.startsWith('data:image/svg+xml;base64,')) {
          svg = atob(imageDataUrl.split(',')[1]);
        }

        // Fetch traits
        const traits = await contract.getTraits(tokenId);
        const formattedTraits = formatTraits([traits.background, traits.rock, traits.flower, traits.mineral, traits.sparkle]);

        return { id: tokenId + 1, traits: formattedTraits, svg }; // tokenId starts from 0
      } catch (err) {
        console.warn(`Failed to fetch token ${tokenId}:`, err);
        return null;
      }
    }

    function displayThumbnails() {
      gallery.innerHTML = '';
      rocks.forEach((rock, i) => {
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        let miniSvg = rock.svg ? rock.svg.replace(/width="[^"]*"/, 'width="100%"').replace(/height="[^"]*"/, 'height="100%"') : 
          `<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#333"/><text x="16" y="18" text-anchor="middle" fill="#00d4ff" font-size="12">Rock #${rock.id}</text></svg>`;
        thumb.innerHTML = `<img src="data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(miniSvg)))}" alt="Thumb ${rock.id}">`;
        gallery.appendChild(thumb);
      });
      setupThumbnails();
    }

    // === PARTICLES ===
    function createStars() {
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 5 + 's';
        stars.appendChild(star);
      }
    }

    // === CSS ANIMATIONS ===
    const style = document.createElement('style');
    style.textContent = `
      @keyframes dash {
        to { stroke-dashoffset: 0; }
      }
      @keyframes sparkle {
        0%, 100% { r: 5; opacity: 0.3; }
        50% { r: 20; opacity: 1; }
      }
      path, rect, ellipse, circle { stroke-dasharray: 100; stroke-dashoffset: 100; }
    `;
    document.head.appendChild(style);

    // === INIT ===
    createStars();
    fetchStats();
    fetchRocks();
  </script>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</body>
</html>
