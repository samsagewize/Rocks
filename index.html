<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyperRocks</title>
  <style>
    body {
      background: #0f0f1a;
      color: #e0e0ff;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #00d4ff;
      text-shadow: 0 0 25px rgba(0, 212, 255, 0.6);
      margin-bottom: 10px;
    }
    .builder {
      background: #1a1a2e;
      border: 1px solid #00d4ff;
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      width: 100%;
    }
    input {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #00d4ff;
      background: #0f0f1a;
      color: #e0e0ff;
      border-radius: 5px;
      margin: 10px;
      width: 200px;
    }
    button {
      background: #00d4ff;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
    }
    #svgOutput {
      margin-top: 20px;
      border: 1px solid #00d4ff;
      border-radius: 10px;
      overflow: auto;
      max-height: 600px;
      background: #0f0f1a;
    }
    #svgOutput svg {
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    .traits {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    .trait {
      background: rgba(0, 212, 255, 0.2);
      padding: 5px 10px;
      border-radius: 5px;
      border: 1px solid #00d4ff;
      font-size: 0.9em;
    }
    .error {
      color: #ff6b6b;
      margin: 10px;
    }
    .loading {
      color: #00d4ff;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>HyperRocks SVG Builder</h1>
  <p>Enter a tokenId (0-1110) to build the SVG from contract traits.</p>

  <div class="builder">
    <input type="number" id="tokenId" placeholder="Token ID (e.g., 0)" min="0" max="1110">
    <button onclick="buildSVG()">Build SVG</button>

    <div id="loading" class="loading" style="display: none;">Fetching traits from contract...</div>
    <div id="error" class="error" style="display: none;"></div>

    <div id="traits" class="traits" style="display: none;"></div>

    <div id="svgOutput" style="display: none;"></div>
  </div>

  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <script>
    // === CONTRACT CONFIG ===
    const CONTRACT_ADDRESS = '0x4cf79252ea6861c4338284e1a1f724d4e7ef667b';
    const RPC_URL = 'https://rpc.hyperliquid.xyz/evm';
    const ABI = [
      'function getTraits(uint256 tokenId) view returns (uint256 background, uint256 rock, uint256 flower, uint256 mineral, uint256 sparkle)'
    ];

    // === TRAIT DATA (Mocked from RockData.sol patterns; replace with on-chain fetch if exposed) ===
    const BACKGROUND_DATA = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF']; // Example hex colors
    const LAYER_DATA = { // Bytes for rock, flower, mineral, sparkle (mock pixel data as hex strings for simplicity)
      rock: ['0x050aFF0000', '0x060b00FF00'], // Example: [x=5,y=10,r=255,g=0,b=0], etc.
      flower: ['0x070cFFFF00'],
      mineral: ['0x080d00FFFF'],
      sparkle: ['0x090eFFFFFF']
    };

    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    async function buildSVG() {
      const tokenId = parseInt(document.getElementById('tokenId').value);
      if (isNaN(tokenId) || tokenId < 0 || tokenId > 1110) {
        showError('Invalid tokenId (0-1110)');
        return;
      }

      showLoading(true);
      hideError();
      hideTraits();
      hideOutput();

      try {
        // Step 1: Fetch traits on-chain
        const traits = await contract.getTraits(tokenId);
        const traitObj = {
          background: traits.background.toNumber(),
          rock: traits.rock.toNumber(),
          flower: traits.flower.toNumber(),
          mineral: traits.mineral.toNumber(),
          sparkle: traits.sparkle.toNumber()
        };

        // Display traits
        showTraits(traitObj);

        // Step 2: Build SVG
        const svg = generateSVG(traitObj);

        // Step 3: Render
        document.getElementById('svgOutput').innerHTML = svg;
        document.getElementById('svgOutput').style.display = 'block';

      } catch (err) {
        showError('Failed to build SVG: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    function generateSVG(traits) {
      // Step 1: Background
      const bgColor = BACKGROUND_DATA[traits.background % BACKGROUND_DATA.length];
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" shape-rendering="crispEdges" width="512" height="512">
        <rect width="32" height="32" fill="${bgColor}"/>`;

      // Step 2: Layers (rock, flower, mineral, sparkle)
      const layers = ['rock', 'flower', 'mineral', 'sparkle'];
      layers.forEach(layer => {
        svg += optimizeLayer(LAYER_DATA[layer], traits[layer]);
      });

      // Step 3: Close SVG
      svg += '</svg>';
      return svg;
    }

    function optimizeLayer(dataBytes, traitIndex) {
      // Mock parsing: Convert hex bytes to rectangles (in real: parse 5-byte chunks [x,y,r,g,b])
      // Sort by y, then x; merge horizontal same-color rects
      const rects = []; // e.g., [{x:5, y:10, width:1, height:1, r:255, g:0, b:0}]
      // Simulate merging
      const merged = dataBytes.map(hex => {
        const bytes = ethers.utils.arrayify(hex);
        const x = bytes[0], y = bytes[1], r = bytes[2], g = bytes[3], b = bytes[4];
        return `<rect x="${x}" y="${y}" width="1" height="1" fill="rgb(${r},${g},${b})"/>`;
      }).join(''); // In full impl: merge adjacent

      return merged;
    }

    // === UI HELPERS ===
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.style.display = 'block';
    }
    function hideError() {
      document.getElementById('error').style.display = 'none';
    }
    function showTraits(traits) {
      const el = document.getElementById('traits');
      el.innerHTML = Object.entries(traits).map(([k, v]) => `<span class="trait">${k}: ${v}</span>`).join('');
      el.style.display = 'flex';
    }
    function hideTraits() {
      document.getElementById('traits').style.display = 'none';
    }
    function hideOutput() {
      document.getElementById('svgOutput').style.display = 'none';
    }
  </script>
</body>
</html>
